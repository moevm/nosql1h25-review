<div style="display: flex; justify-content: space-between; align-items: center; width: 100%; margin-bottom: 20px;">
  <h2 style="margin: 0;">My Account</h2>
  <span style="color: gray; font-size: 0.9rem; text-align: right;">
    Created at: {{ user.createdAt }} | Last modified: {{ user.lastModified }}
  </span>
</div>

<div class="account-content">
  <!-- Табы -->
  <div class="tabs" style="display: flex; border-bottom: 2px solid #eee; margin-bottom: 20px;">
    <button class="tab-button active" data-tab="personal">Change Personal Info</button>
    <button class="tab-button" data-tab="password">Change Password</button>
    {% if user.role == 'admin' %}
    <button class="tab-button" data-tab="addgame">Add Game Card</button>
    {% endif %}
  </div>

  <!-- Personal Info Form -->
  <div class="tab-content active" id="tab-personal">
    <form method="post" enctype="multipart/form-data" id="ChangePersonalDataForm" style="display: flex; flex-direction: column; gap: 15px;">
      {% csrf_token %}
      <input type="hidden" name="form_type" value="personal">

      {% for field in personal_form %}
        <div class="form-group" style="display: flex; flex-direction: column; width: 50%;">
          {{ field.label_tag }}
          {{ field.errors }}
          {{ field }}
          {{ field.help_text }}
        </div>
      {% endfor %}

      <button type="submit" style="width: 25%; background-color: #FFBD3F; color: black; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 20px;">
        Save
      </button>
    </form>
  </div>

  <!-- Password Change Form -->
  <div class="tab-content" id="tab-password" style="display: none;">
    <form method="post" id="ChangePasswordForm" style="display: flex; flex-direction: column; gap: 15px;">
      {% csrf_token %}
      <input type="hidden" name="form_type" value="password">

      {% for field in password_form %}
        <div class="form-group" style="display: flex; flex-direction: column; width: 50%;">
          {{ field.label_tag }}
          {{ field.errors }}
          {{ field }}
          {{ field.help_text }}
        </div>
      {% endfor %}

      <button type="submit" style="width: 25%; background-color: #FFBD3F; color: black; padding: 12px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; font-size: 1rem; margin-top: 20px;">
        Save New Password
      </button>
    </form>
  </div>

{% if user.role == 'admin' %}
<!-- Add Game Card Form -->
<div class="tab-content" id="tab-addgame" style="display: none;">
  <form method="post" id="AddGameCardForm" style="display: flex; flex-direction: column; gap: 30px; width: 100%; font-family: 'Inter', sans-serif;">
    {% csrf_token %}
    <input type="hidden" name="form_type" value="addgame">

    <!-- Контейнер с полями формы -->
    <div style="display: flex; gap: 40px; align-items: flex-start; flex-wrap: wrap;">

      <!-- Левая колонка: Изображение -->
      <div style="flex-shrink: 0; display: flex; flex-direction: column; gap: 15px; width: 300px;">
        <div style="display: flex; flex-direction: column; gap: 5px;">
          <label style="font-weight: 600; font-size: 14px;">Image URL:</label>
          <input type="text" name="image_url" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;" placeholder="https://example.com/image.jpg">
        </div>

        <!-- Превью изображения -->
        <div style="width: 176px; height: 264px; background-color: #f0f0f0; border-radius: 8px; overflow: hidden;">
          <img id="gameImagePreview" src="" alt="Game Image Preview" style="width: 100%; height: 100%; object-fit: cover; display: none;">
        </div>
      </div>

      <div style="flex: 1; display: flex; gap: 40px; flex-wrap: wrap;">

        <!-- Текстовые поля -->
        <div style="flex: 1; min-width: 250px; display: flex; flex-direction: column; gap: 15px;">
          <div style="display: flex; flex-direction: column; gap: 5px;">
            <label style="font-weight: 600; font-size: 14px;">Name:</label>
            <input type="text" name="name" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;">
          </div>

          <div style="display: flex; flex-direction: column; gap: 5px;">
            <label style="font-weight: 600; font-size: 14px;">Description:</label>
            <textarea name="description" rows="3" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;"></textarea>
          </div>

          <div style="display: flex; flex-direction: column; gap: 5px;">
            <label style="font-weight: 600; font-size: 14px;">Released On:</label>
            <input type="date" name="released_on" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;">
          </div>

          <div style="display: flex; flex-direction: column; gap: 5px;">
            <label style="font-weight: 600; font-size: 14px;">Game Author:</label>
            <input type="text" name="game_author" style="padding: 10px; border: 1px solid #ccc; border-radius: 6px; font-size: 14px;">
          </div>
        </div>

        <!-- Чекбоксы -->
        <div style="flex: 1; min-width: 250px; display: flex; flex-direction: column; gap: 30px;">
          <!-- Platforms Dropdown -->
          <div class="dropdown-container">
            <label style="font-weight: 700; font-size: 16px;">Platforms:</label>
            <div class="dropdown">
              <button class="dropdown-toggle" type="button" onclick="toggleDropdown('platforms-dropdown')">
                Select Platforms ▼
              </button>
              <div id="platforms-dropdown" class="dropdown-content">
                <label><input type="checkbox" name="platforms" value="PS5"> PS5</label>
                <label><input type="checkbox" name="platforms" value="Xbox Series X/S"> Xbox Series X/S</label>
                <label><input type="checkbox" name="platforms" value="Nintendo Switch"> Nintendo Switch</label>
                <label><input type="checkbox" name="platforms" value="PC"> PC</label>
                <label><input type="checkbox" name="platforms" value="Mobile"> Mobile</label>
              </div>
            </div>
            <div id="selected-platforms" class="selected-items"></div>
          </div>

          <!-- Genres Dropdown -->
          <div class="dropdown-container">
            <label style="font-weight: 700; font-size: 16px;">Genres:</label>
            <div class="dropdown">
              <button class="dropdown-toggle" type="button" onclick="toggleDropdown('genres-dropdown')">
                Select Genres ▼
              </button>
              <div id="genres-dropdown" class="dropdown-content">
                <div style="column-count: 2; column-gap: 20px;">
                  <label><input type="checkbox" name="genres" value="Action"> Action</label>
                  <label><input type="checkbox" name="genres" value="Adventure"> Adventure</label>
                  <label><input type="checkbox" name="genres" value="Role-playing (RPG)"> Role-playing (RPG)</label>
                  <label><input type="checkbox" name="genres" value="Strategy"> Strategy</label>
                  <label><input type="checkbox" name="genres" value="Simulation"> Simulation</label>
                  <label><input type="checkbox" name="genres" value="Sports"> Sports</label>
                  <label><input type="checkbox" name="genres" value="Racing"> Racing</label>
                  <label><input type="checkbox" name="genres" value="Fighting"> Fighting</label>
                  <label><input type="checkbox" name="genres" value="Puzzle"> Puzzle</label>
                  <label><input type="checkbox" name="genres" value="Horror"> Horror</label>
                  <label><input type="checkbox" name="genres" value="Survival"> Survival</label>
                  <label><input type="checkbox" name="genres" value="Battle Royale"> Battle Royale</label>
                  <label><input type="checkbox" name="genres" value="MMORPG"> MMORPG</label>
                  <label><input type="checkbox" name="genres" value="MOBA"> MOBA</label>
                  <label><input type="checkbox" name="genres" value="Platformer"> Platformer</label>
                  <label><input type="checkbox" name="genres" value="Stealth"> Stealth</label>
                  <label><input type="checkbox" name="genres" value="Sandbox"> Sandbox</label>
                  <label><input type="checkbox" name="genres" value="Open World"> Open World</label>
                  <label><input type="checkbox" name="genres" value="First-person Shooter (FPS)"> First-person Shooter (FPS)</label>
                  <label><input type="checkbox" name="genres" value="Third-person Shooter (TPS)"> Third-person Shooter (TPS)</label>
                  <label><input type="checkbox" name="genres" value="Tactical Shooter"> Tactical Shooter</label>
                  <label><input type="checkbox" name="genres" value="Roguelike"> Roguelike</label>
                  <label><input type="checkbox" name="genres" value="Metroidvania"> Metroidvania</label>
                  <label><input type="checkbox" name="genres" value="Visual Novel"> Visual Novel</label>
                  <label><input type="checkbox" name="genres" value="Rhythm"> Rhythm</label>
                  <label><input type="checkbox" name="genres" value="Party"> Party</label>
                  <label><input type="checkbox" name="genres" value="Educational"> Educational</label>
                  <label><input type="checkbox" name="genres" value="Card Game"> Card Game</label>
                  <label><input type="checkbox" name="genres" value="Board Game"> Board Game</label>
                  <label><input type="checkbox" name="genres" value="Trivia"> Trivia</label>
                  <!-- Добавляй здесь остальные жанры -->
                </div>
              </div>
            </div>
            <div id="selected-genres" class="selected-items"></div>
          </div>
        </div>

      </div>
    </div>

    <!-- Кнопка отправки — вынесена отдельно -->
    <div style="display: flex; justify-content: center; margin-top: 20px;">
      <button type="submit" style="width: 220px; background-color: #FFBD3F; color: black; padding: 14px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 1.1rem; transition: 0.3s;">
        Save Game Card
      </button>
    </div>

  </form>
</div>
{% endif %}


</div>

<!-- Стили табов -->
<style>
  .tab-button {
    padding: 10px 20px;
    border: none;
    background: none;
    font-weight: bold;
    cursor: pointer;
    font-size: 1rem;
    color: gray;
    border-bottom: 3px solid transparent;
    transition: all 0.3s;
  }

  .tab-button.active {
    color: black;
    border-bottom: 3px solid #FFBD3F;
    background-color: #fff8e5;
  }

  .tab-button:hover {
    color: #FFBD3F;
  }

  .tab-content {
    transition: all 0.3s;
  }
  .dropdown-container {
    position: relative;
    margin-bottom: 15px;
  }

  .dropdown {
    position: relative;
    display: inline-block;
    width: 100%;
  }

  .dropdown-toggle {
    background-color: #f8f9fa;
    color: #333;
    padding: 10px 15px;
    border: 1px solid #ddd;
    border-radius: 4px;
    cursor: pointer;
    width: 100%;
    text-align: left;
    font-size: 14px;
    margin-top: 5px;
    transition: all 0.3s;
  }

  .dropdown-toggle:hover {
    background-color: #e9ecef;
  }

  .dropdown-content {
    display: none;
    position: absolute;
    background-color: white;
    width: 100%;
    max-height: 300px;
    overflow-y: auto;
    border: 1px solid #ddd;
    border-radius: 4px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    z-index: 1000;
    padding: 15px;
  }

  .dropdown-content label {
    display: block;
    padding: 5px 10px;
    cursor: pointer;
    white-space: nowrap;
  }

  .dropdown-content label:hover {
    background-color: #f1f1f1;
  }

  .selected-items {
    margin-top: 10px;
    font-size: 14px;
    color: #666;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
  }

  .selected-item {
    background-color: #e9ecef;
    padding: 4px 12px;
    border-radius: 15px;
    font-size: 13px;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .selected-item button {
    background: none;
    border: none;
    color: #999;
    cursor: pointer;
    font-size: 12px;
    padding: 0;
  }

  .selected-item button:hover {
    color: #666;
  }
</style>

<!-- Скрипт переключения вкладок + превью картинки -->
<script>
  function toggleDropdown(dropdownId) {
    const dropdown = document.getElementById(dropdownId);
    dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';

    // Close other dropdowns
    document.querySelectorAll('.dropdown-content').forEach(item => {
      if (item.id !== dropdownId) {
        item.style.display = 'none';
      }
    });
  }

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(event) {
    if (!event.target.closest('.dropdown')) {
      document.querySelectorAll('.dropdown-content').forEach(dropdown => {
        dropdown.style.display = 'none';
      });
    }
  });
  // Initialize checkboxes and selected items
  document.addEventListener('DOMContentLoaded', function() {
    // Setup platform checkboxes
    document.querySelectorAll('input[name="platforms"]').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        updateSelectedItems('platforms', this.value, this.checked);
      });
    });

    // Setup genre checkboxes
    document.querySelectorAll('input[name="genres"]').forEach(checkbox => {
      checkbox.addEventListener('change', function() {
        updateSelectedItems('genres', this.value, this.checked);
      });
    });
  });

  // Update selected items display
  function updateSelectedItems(type, value, isChecked) {
    const containerId = `selected-${type}`;
    const container = document.getElementById(containerId);
    const itemId = `${type}-${value.replace(/\s+/g, '-').toLowerCase()}`;

    if (isChecked) {
      // Create new selected item
      const item = document.createElement('div');
      item.className = 'selected-item';
      item.id = itemId;
      item.innerHTML = `
        ${value}
        <button onclick="removeSelectedItem('${type}', '${value.replace(/'/g, "\\'")}')">×</button>
      `;
      container.appendChild(item);
    } else {
      // Remove selected item
      const item = document.getElementById(itemId);
      if (item) {
        container.removeChild(item);
      }
    }
  }

  // Remove selected item
  function removeSelectedItem(type, value) {
    const checkbox = document.querySelector(`input[name="${type}"][value="${value}"]`);
    if (checkbox) {
      checkbox.checked = false;
      updateSelectedItems(type, value, false);
    }
  }
  document.addEventListener("DOMContentLoaded", function() {
    const tabButtons = document.querySelectorAll('.tab-button');
    const tabContents = document.querySelectorAll('.tab-content');


    if (tabButtons.length > 0 && !tabButtons[0].classList.contains('active')) {
      const firstVisibleTab = Array.from(tabButtons).find(btn => btn.style.display !== 'none');
      if (firstVisibleTab) {
        firstVisibleTab.classList.add('active');
        const tab = firstVisibleTab.getAttribute('data-tab');
        document.getElementById(`tab-${tab}`).style.display = 'block';
      }
    }

    tabButtons.forEach(button => {
      button.addEventListener('click', () => {
        const tab = button.getAttribute('data-tab');

        tabButtons.forEach(btn => btn.classList.remove('active'));
        button.classList.add('active');

        tabContents.forEach(content => {
          if (content.id === 'tab-' + tab) {
            content.style.display = tab === "addgame" ? "flex" : "block";
            content.classList.add('active');
          } else {
            content.style.display = 'none';
            content.classList.remove('active');
          }
        });
      });
    });
  });

  function previewImageFromUrl() {
    const urlInput = document.querySelector('input[name="image_url"]');
    const image = document.getElementById('gameImagePreview');

    if (urlInput.value) {
      image.src = urlInput.value;
      image.style.display = 'block';
      image.onerror = function() {
        image.style.display = 'none';
        alert('Could not load image from the provided URL');
      };
    } else {
      image.style.display = 'none';
    }
  }

  document.querySelector('input[name="image_url"]').addEventListener('input', previewImageFromUrl);
</script>